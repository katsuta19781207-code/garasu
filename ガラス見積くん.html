<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¬ãƒ´ã‚£ã‚¢ æˆ¦ç•¥çš„è³¼è²·ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼(2026å¹´3æœˆæ”¹å®šå¯¾å¿œç‰ˆ)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
  :root { --bg: #0d0f14; --surface: #161920; --surface2: #1e2230; --border: #2a2f3e; --accent: #4fc3f7; --accent2: #00e676; --warn: #ff9800; --danger: #f44336; --text: #e8eaf0; --muted: #6b7280; --hamashin: #4fc3f7; --bando: #a78bfa; --optimal: #00e676; --acceptable: #29b6f6; }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans JP', sans-serif; background: var(--bg); color: var(--text); padding: 24px 16px; }
  .header { text-align: center; margin-bottom: 24px; }
  .header h1 { font-size: 20px; font-weight: 900; color: var(--accent); letter-spacing: 0.1em; }
  .header p { color: var(--accent2); font-size: 12px; font-weight: 700; margin-top: 4px; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin: 0 auto 16px; max-width: 900px; }
  .card-title { font-size: 11px; font-weight: 700; color: var(--muted); text-transform: uppercase; margin-bottom: 16px; padding-bottom: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;}
  .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
  .input-group { display: flex; flex-direction: column; gap: 4px; }
  label { font-size: 11px; font-weight: 700; color: var(--muted); }
  input, select { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); padding: 8px 12px; font-family: 'JetBrains Mono', monospace; font-size: 14px; outline: none; }
  input:focus { border-color: var(--accent); }
  .checkbox-group { display: flex; align-items: center; gap: 8px; font-size: 12px; cursor: pointer; }
  .btn-calc { width: 100%; padding: 14px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: 900; cursor: pointer; margin-top: 16px; transition: opacity 0.2s; font-family: 'Noto Sans JP', sans-serif; font-size: 14px; }
  .btn-calc:hover { opacity: 0.9; }
  .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  @media (max-width: 600px) { .result-grid { grid-template-columns: 1fr; } }
  .company-card { background: var(--surface2); border-radius: 10px; padding: 16px; border: 2px solid transparent; position: relative; }
  .company-card.optimal { border-color: var(--optimal); }
  .company-card.acceptable { border-color: var(--acceptable); }
  .price-main { font-family: 'JetBrains Mono', monospace; font-size: 26px; font-weight: 700; margin: 4px 0; }
  .price-label { font-size: 11px; color: var(--muted); margin-bottom: 4px; }
  .breakdown-section { margin-top: 12px; padding-top: 12px; border-top: 1px dashed var(--border); }
  .breakdown-title { font-size: 10px; color: var(--muted); margin-bottom: 8px; letter-spacing: 0.05em; text-align: center; }
  .breakdown-row { display: flex; justify-content: space-between; font-size: 11px; color: var(--text); padding: 3px 0; font-family: 'JetBrains Mono', monospace; }
  .breakdown-row.highlight-opt { color: var(--optimal); }
  .breakdown-row.highlight-warn { color: var(--warn); }
  .breakdown-row.highlight-danger { color: var(--danger); font-weight: bold; }
  .market-insight-box { margin-top: 16px; padding: 16px; background: rgba(79, 195, 247, 0.05); border: 1px solid rgba(79, 195, 247, 0.3); border-radius: 8px; }
  .market-insight-title { font-size: 11px; font-weight: 900; color: var(--accent); letter-spacing: 0.05em; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
  .market-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center; }
  .market-col { background: var(--surface); padding: 10px; border-radius: 6px; border: 1px solid var(--border); }
  .market-col-title { font-size: 10px; color: var(--muted); margin-bottom: 6px; }
  .market-price { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 700; color: var(--text); }
  .market-margin { font-size: 10px; margin-top: 4px; font-family: 'JetBrains Mono', monospace; }
  .margin-high { color: var(--danger); }
  .margin-low { color: var(--optimal); }
  .warn-box { background: rgba(255,152,0,0.1); border: 1px solid var(--warn); border-radius: 6px; padding: 10px; color: var(--warn); font-size: 11px; margin-bottom: 12px; line-height: 1.4; }
  .log-table-wrap { overflow-x: auto; margin-top: 12px; }
  table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 11px; text-align: left; }
  th, td { padding: 8px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  th { background: var(--surface2); color: var(--muted); }
  .revision-box { grid-column: span 2; padding: 10px 12px; background: rgba(244, 67, 54, 0.1); border: 1px solid var(--danger); border-radius: 6px; margin-top: 8px; }
  @media (max-width: 600px) { .revision-box { grid-column: span 1; } }

  /* ===== æ­©ç•™ã¾ã‚Šãƒ‘ãƒãƒ« ===== */
  .yield-panel { margin-top: 20px; }
  .yield-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; flex-wrap: wrap; gap: 8px; }
  .yield-header-left { display: flex; align-items: center; gap: 10px; }
  .yield-title { font-size: 13px; font-weight: 900; color: var(--accent2); letter-spacing: 0.08em; }
  .yield-select-wrap { display: flex; align-items: center; gap: 8px; }
  .yield-select-wrap label { font-size: 10px; color: var(--muted); white-space: nowrap; }
  .yield-select-wrap select { font-size: 12px; padding: 5px 8px; width: auto; }

  .yield-body { display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start; }
  @media (max-width: 640px) { .yield-body { grid-template-columns: 1fr; } }

  /* canvas wrapper */
  .canvas-wrap {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  .canvas-label { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  canvas { display: block; border-radius: 4px; }

  /* çµ±è¨ˆã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« */
  .yield-stats { min-width: 200px; display: flex; flex-direction: column; gap: 10px; }
  .stat-block {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
  }
  .stat-label { font-size: 10px; color: var(--muted); margin-bottom: 4px; letter-spacing: 0.05em; }
  .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 700; }
  .stat-sub { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
  .stat-value.good { color: var(--optimal); }
  .stat-value.warn { color: var(--warn); }
  .stat-value.danger { color: var(--danger); }

  /* å‡¡ä¾‹ */
  .legend { display: flex; gap: 14px; flex-wrap: wrap; margin-top: 4px; }
  .legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .legend-dot { width: 12px; height: 12px; border-radius: 2px; flex-shrink: 0; }

  /* rotation toggle */
  .toggle-btn { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-size: 11px; padding: 4px 10px; cursor: pointer; font-family: 'Noto Sans JP', sans-serif; transition: all 0.2s; }
  .toggle-btn:hover, .toggle-btn.active { border-color: var(--accent2); color: var(--accent2); background: rgba(0,230,118,0.07); }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸªŸ LEVIA Strategic Estimator</h1>
  <p>âœ“ 2026å¹´3æœˆ æµœæ–°ç¡å­ ä¾¡æ ¼æ”¹å®š(10%UP) ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ</p>
</div>

<!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="card">
  <div class="card-title">âš™ï¸ CONFIGURATION</div>
  <div class="input-grid">
    <div class="input-group"><label>å¹… W (mm)</label><input type="number" id="width" value="472"></div>
    <div class="input-group"><label>é«˜ã• H (mm)</label><input type="number" id="height" value="445"></div>
    <div class="input-group">
      <label>åŸºæ¿ã‚¬ãƒ©ã‚¹</label>
      <select id="substrate">
        <option value="high_trans" selected>CFL 4mm (é«˜é€é)</option>
        <option value="clear">FL 4mm (æ™®é€šé€æ˜)</option>
        <option value="tempered_high">å¼·åŒ– CFL 4mm</option>
        <option value="tempered_clear">å¼·åŒ– FL 4mm</option>
        <option value="bronze">BFL 4mm (ãƒ–ãƒ­ãƒ³ã‚º)</option>
        <option value="frost">ãƒ•ãƒ­ã‚¹ãƒˆ 4mm</option>
      </select>
    </div>
    <div class="input-group">
      <label>ãƒ•ã‚£ãƒ«ãƒ </label>
      <select id="film">
        <option value="none">ãªã—ï¼ˆç´ åœ°ãªã©ï¼‰</option>
        <option value="kik_m50">KIK-M50 (é£›æ•£é˜²æ­¢)</option>
        <option value="c714">C-714 (ä¹³ç™½)</option>
        <option value="c18">C-18</option>
        <option value="dnp_t2">DNP-T2</option>
        <option value="milky_milky" selected>ãƒŸãƒ«ã‚­ãƒ¼ãƒŸãƒ«ã‚­ãƒ¼</option>
        <option value="zh05">ZH05 (é«˜ç´š)</option>
      </select>
    </div>
    <div class="input-group">
      <label>ã‚¨ãƒƒã‚¸åŠ å·¥ (å¤–å‘¨)</label>
      <select id="edge_type">
        <option value="ito" selected>ç³¸é¢ï¼ˆç°¡æ˜“é¢å–ã‚Šãƒ»ç„¡æ–™ï¼‰</option>
        <option value="migaki">ç£¨ãé¢ï¼ˆãƒ„ãƒ¤å‡ºã—ãƒ»æœ‰æ–™ï¼‰</option>
      </select>
    </div>
    <div class="input-group"><label>ç™ºæ³¨æšæ•° (Lot)</label><input type="number" id="qty" value="40"></div>
  </div>

  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 15px;">
    <div><label class="checkbox-group"><input type="checkbox" id="minAreaRule"> 0.3ã¡ æœ€å°èª²é‡‘ãƒ«ãƒ¼ãƒ«é©ç”¨</label></div>
    <div><label class="checkbox-group"><input type="checkbox" id="tapeOption"> ä¸¡é¢ãƒ†ãƒ¼ãƒ—è²¼ã‚Šç­‰ï¼ˆç‰¹æ®ŠåŠ ç®—ï¼‰</label></div>
    <div class="revision-box">
      <label class="checkbox-group" style="color: var(--danger); font-weight: 700;">
        <input type="checkbox" id="hamashinRevision">
        ğŸ“ˆ ã€æµœæ–°ç¡å­ã€‘2026å¹´3æœˆ ä¾¡æ ¼æ”¹å®šã‚’é©ç”¨ (+10%)
      </label>
    </div>
  </div>
  <button class="btn-calc" onclick="calculate()">â–¶ ã‚³ã‚¹ãƒˆå†…è¨³ã‚’è¨ˆç®—</button>
</div>

<!-- çµæœ -->
<div class="card" id="result-section" style="display:none;">
  <div class="card-title">ğŸ’° OUTPUT RESULT <span id="logic-info" style="text-transform:none; font-weight:400; color: var(--accent);"></span></div>
  <div class="result-grid" id="result-grid"></div>
  <div class="market-insight-box" id="market-insight"></div>
</div>

<!-- â˜… æ­©ç•™ã¾ã‚Šãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ â˜… -->
<div class="card" id="yield-section" style="display:none;">
  <div class="card-title" style="margin-bottom:0; border:none; padding-bottom:0;">
    <span>ğŸ“ YIELD VISUALIZER â€” åŸæ¿æ­©ç•™ã¾ã‚Š</span>
  </div>

  <div class="yield-panel">
    <div class="yield-header">
      <div class="yield-header-left">
        <div class="yield-select-wrap">
          <label>åŸæ¿ã‚µã‚¤ã‚º</label>
          <select id="plate-select" onchange="renderYield()">
            <option value="3048,2134">3048 Ã— 2134 mm (æœ€å¤§æ¿)</option>
            <option value="2438,1829">2438 Ã— 1829 mm (å¤§æ¿)</option>
            <option value="1829,1219" selected>1829 Ã— 1219 mm (æ¨™æº–æ¿)</option>
            <option value="1220,910">1220 Ã— 910 mm (å°æ¿)</option>
            <option value="900,600">900 Ã— 600 mm (ã‚«ãƒƒãƒˆå“)</option>
          </select>
        </div>
        <button class="toggle-btn" id="rot-btn" onclick="toggleRotation()">ğŸ”„ éƒ¨æã‚’90Â°å›è»¢</button>
        <div class="yield-select-wrap">
          <label>ç«¯éƒ¨ãƒãƒ¼ã‚¸ãƒ³</label>
          <input type="number" id="edge-margin" value="10" min="0" max="50" style="width:64px; font-size:12px; padding:5px 8px;" onchange="renderYield()">
          <label style="margin-left:-4px;">mm</label>
        </div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:rgba(79,195,247,0.7);"></div>æœ‰åŠ¹é¢ç©</div>
        <div class="legend-item"><div class="legend-dot" style="background:rgba(244,67,54,0.45);"></div>ç«¯æãƒ­ã‚¹</div>
        <div class="legend-item"><div class="legend-dot" style="border:1px dashed rgba(255,255,255,0.3);"></div>ã‚«ãƒƒãƒˆç·š</div>
      </div>
    </div>

    <div class="yield-body">
      <div class="canvas-wrap">
        <canvas id="yield-canvas"></canvas>
        <div class="canvas-label" id="canvas-label">â€“</div>
      </div>
      <div class="yield-stats" id="yield-stats"></div>
    </div>
  </div>
</div>

<!-- ãƒ­ã‚° -->
<div class="card">
  <div class="card-title">ğŸ“‹ EXECUTION LOGS
    <button onclick="copyTSV()" style="background:none; border:1px solid var(--accent); color:var(--accent); font-size:10px; padding:4px 8px; border-radius:4px; cursor:pointer; font-weight:bold; font-family:'Noto Sans JP';">Excelã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
  </div>
  <div class="log-table-wrap">
    <table>
      <thead>
        <tr><th>Size (WÃ—H)</th><th>Qty</th><th>ä»•æ§˜ (Glass/Film)</th><th>æµœæ–°(1æš)</th><th>å‚æ±(1æš)</th><th>å€ç‡ Ratio</th><th>åˆ¤å®š Status</th><th>å·®é¡ Diff</th></tr>
      </thead>
      <tbody id="log-body"></tbody>
    </table>
  </div>
</div>

<script>
// ===============================
// ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
// ===============================
const MASTER = {
  hamashin: { fixed: 700, edge_price: 800, discountThreshold: 40, discountRate: 0.15,
    sub: { high_trans: 7700, clear: 5500, bronze: 6500, tempered_high: 12000, tempered_clear: 9500, frost: 9000 },
    film: { none: 0, kik_m50: 700, c714: 1800, c18: 1800, dnp_t2: 2500, milky_milky: 3700, zh05: 5800 }
  },
  bando: { fixed: 350, edge_price: 0, discountThreshold: 100, discountRate: 0.05,
    sub: { high_trans: 6940, clear: 5500, bronze: 6500, tempered_high: 12000, tempered_clear: 9500, frost: 9000 },
    film: { none: 0, kik_m50: 700, c714: 1860, c18: 1860, dnp_t2: 2500, milky_milky: 4600, zh05: 5800 }
  }
};
const MARKET_COST = { high_trans: 3500, clear: 1500, bronze: 2500, tempered_high: 6000, tempered_clear: 4000, frost: 4500 };
const LABELS = {
  sub: { high_trans: "CFL", clear: "FL", bronze: "BFL", tempered_high: "å¼·åŒ–CFL", tempered_clear: "å¼·åŒ–FL", frost: "ãƒ•ãƒ­ã‚¹ãƒˆ" },
  film: { none: "ç´ åœ°", kik_m50: "KIK", c714: "C-714", c18: "C-18", dnp_t2: "DNP-T2", milky_milky: "ãƒŸãƒ«ã‚­ãƒ¼", zh05: "ZH05" }
};

// ===============================
// æ­©ç•™ã¾ã‚ŠçŠ¶æ…‹
// ===============================
let _yieldState = { w: 0, h: 0, rotated: false };

function toggleRotation() {
  _yieldState.rotated = !_yieldState.rotated;
  const btn = document.getElementById('rot-btn');
  btn.classList.toggle('active', _yieldState.rotated);
  renderYield();
}

function renderYield() {
  if (!_yieldState.w || !_yieldState.h) return;

  const plateVal = document.getElementById('plate-select').value.split(',');
  const PW = parseInt(plateVal[0]);
  const PH = parseInt(plateVal[1]);
  const MARGIN = parseInt(document.getElementById('edge-margin').value) || 0;
  // NCãƒ«ãƒ¼ã‚¿ãƒ¼ï¼šç«¯éƒ¨ãƒãƒ¼ã‚¸ãƒ³ã‚’ä¸¡å´å¼•ã„ãŸæœ‰åŠ¹ã‚¨ãƒªã‚¢ã§è¨ˆç®—
  const effectiveW = PW - MARGIN * 2;
  const effectiveH = PH - MARGIN * 2;

  let pw = _yieldState.rotated ? _yieldState.h : _yieldState.w;
  let ph = _yieldState.rotated ? _yieldState.w : _yieldState.h;

  const cols = Math.floor(effectiveW / pw);
  const rows = Math.floor(effectiveH / ph);
  const count = cols * rows;

  // ä½¿ç”¨é¢ç© / å…¨ä½“é¢ç©
  const usedArea  = count * pw * ph;
  const plateArea = PW * PH;
  const effectiveArea = effectiveW * effectiveH;
  const yieldRate = usedArea / effectiveArea;   // æœ‰åŠ¹ã‚¨ãƒªã‚¢å†…ã§ã®æ­©ç•™ã¾ã‚Š
  const lossArea  = plateArea - usedArea;

  // Canvasæç”»
  const canvas = document.getElementById('yield-canvas');
  const MAX_W = Math.min(520, window.innerWidth - 80);
  const MAX_H = 340;
  const scale = Math.min(MAX_W / PW, MAX_H / PH);
  canvas.width  = Math.round(PW * scale);
  canvas.height = Math.round(PH * scale);
  const ctx = canvas.getContext('2d');

  // èƒŒæ™¯ï¼ˆå…¨ä½“ï¼šç«¯æè‰²ï¼‰
  ctx.fillStyle = 'rgba(244,67,54,0.25)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // ãƒãƒ¼ã‚¸ãƒ³å¸¯ã‚’ã•ã‚‰ã«æš—ãï¼ˆå››è¾ºï¼‰
  const mx = Math.round(MARGIN * scale);
  const my = Math.round(MARGIN * scale);
  ctx.fillStyle = 'rgba(0,0,0,0.35)';
  ctx.fillRect(0, 0, canvas.width, my);                          // ä¸Š
  ctx.fillRect(0, canvas.height - my, canvas.width, my);        // ä¸‹
  ctx.fillRect(0, 0, mx, canvas.height);                        // å·¦
  ctx.fillRect(canvas.width - mx, 0, mx, canvas.height);       // å³
  // ãƒãƒ¼ã‚¸ãƒ³å¯¸æ³•ãƒ©ãƒ™ãƒ«
  if (MARGIN > 0 && mx > 6) {
    ctx.fillStyle = 'rgba(255,180,0,0.85)';
    ctx.font = `bold ${Math.max(9, Math.min(12, mx))}px JetBrains Mono, monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${MARGIN}`, mx / 2, canvas.height / 2);
    ctx.fillText(`${MARGIN}`, canvas.width - mx / 2, canvas.height / 2);
    ctx.fillText(`${MARGIN}`, canvas.width / 2, my / 2);
    ctx.fillText(`${MARGIN}`, canvas.width / 2, canvas.height - my / 2);
  }

  // æœ‰åŠ¹ãƒ”ãƒ¼ã‚¹ï¼ˆãƒãƒ¼ã‚¸ãƒ³åˆ†ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      const x = Math.round(mx + c * pw * scale);
      const y = Math.round(my + r * ph * scale);
      const sw = Math.round(pw * scale);
      const sh = Math.round(ph * scale);

      // å¡—ã‚Š
      ctx.fillStyle = 'rgba(79,195,247,0.55)';
      ctx.fillRect(x, y, sw, sh);

      // ã‚¬ãƒ©ã‚¹å…‰æ²¢æ„Ÿ
      const grad = ctx.createLinearGradient(x, y, x + sw * 0.6, y + sh * 0.6);
      grad.addColorStop(0, 'rgba(255,255,255,0.18)');
      grad.addColorStop(1, 'rgba(255,255,255,0)');
      ctx.fillStyle = grad;
      ctx.fillRect(x, y, sw, sh);

      // æ ç·š
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx.lineWidth = 1;
      ctx.strokeRect(x + 0.5, y + 0.5, sw - 1, sh - 1);

      // ç•ªå·ãƒ©ãƒ™ãƒ«ï¼ˆå¤§ãã™ããªã„å ´åˆï¼‰
      const idx = r * cols + c + 1;
      const fontSize = Math.max(8, Math.min(14, sw / 3.5));
      if (sw > 20 && sh > 16) {
        ctx.fillStyle = 'rgba(255,255,255,0.75)';
        ctx.font = `700 ${fontSize}px JetBrains Mono, monospace`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(idx, x + sw / 2, y + sh / 2);
      }
    }
  }

  // ã‚«ãƒƒãƒˆç·šï¼ˆæ°´å¹³ï¼‰NCãƒ«ãƒ¼ã‚¿ãƒ¼ï¼šãƒã‚³ç›®ãªã—
  ctx.setLineDash([4, 3]);
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.lineWidth = 1;
  for (let r = 1; r < rows; r++) {
    const y = Math.round(my + r * ph * scale);
    ctx.beginPath(); ctx.moveTo(mx, y); ctx.lineTo(canvas.width - mx, y); ctx.stroke();
  }
  // ã‚«ãƒƒãƒˆç·šï¼ˆå‚ç›´ï¼‰
  for (let c = 1; c < cols; c++) {
    const x = Math.round(mx + c * pw * scale);
    ctx.beginPath(); ctx.moveTo(x, my); ctx.lineTo(x, canvas.height - my); ctx.stroke();
  }
  // æœ‰åŠ¹ã‚¨ãƒªã‚¢æ ï¼ˆãƒãƒ¼ã‚¸ãƒ³å†…å´ï¼‰
  ctx.setLineDash([6, 3]);
  ctx.strokeStyle = 'rgba(255,180,0,0.5)';
  ctx.lineWidth = 1.5;
  ctx.strokeRect(mx, my, Math.round(effectiveW * scale), Math.round(effectiveH * scale));
  ctx.setLineDash([]);

  // åŸæ¿å¤–æ 
  ctx.strokeStyle = 'rgba(255,255,255,0.5)';
  ctx.lineWidth = 2;
  ctx.strokeRect(1, 1, canvas.width - 2, canvas.height - 2);

  // ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³
  document.getElementById('canvas-label').textContent =
    `åŸæ¿ ${PW}Ã—${PH}mm  |  æœ‰åŠ¹ã‚¨ãƒªã‚¢ ${effectiveW}Ã—${effectiveH}mmï¼ˆç«¯éƒ¨ãƒãƒ¼ã‚¸ãƒ³Â±${MARGIN}mmï¼‰|  éƒ¨æ ${pw}Ã—${ph}mm`;

  // çµ±è¨ˆãƒ‘ãƒãƒ«
  const rateClass = yieldRate >= 0.75 ? 'good' : yieldRate >= 0.5 ? 'warn' : 'danger';
  const rateEmoji = yieldRate >= 0.75 ? 'ğŸŸ¢' : yieldRate >= 0.5 ? 'ğŸŸ¡' : 'ğŸ”´';

  // ä½•åŸæ¿å¿…è¦ã‹ï¼ˆç™ºæ³¨æšæ•°ã‚’æº€ãŸã™ã«ã¯ï¼‰
  const qty = parseInt(document.getElementById('qty').value) || 1;
  const platesNeeded = count > 0 ? Math.ceil(qty / count) : 'â€“';

  document.getElementById('yield-stats').innerHTML = `
    <div class="stat-block">
      <div class="stat-label">1åŸæ¿ã‚ãŸã‚Šå–ã‚Œæ•°</div>
      <div class="stat-value ${count > 0 ? 'good' : 'danger'}">${count > 0 ? count : 0} æš</div>
      <div class="stat-sub">${cols} åˆ— Ã— ${rows} è¡Œ</div>
    </div>
    <div class="stat-block">
      <div class="stat-label">æ­©ç•™ã¾ã‚Šç‡ ${rateEmoji}</div>
      <div class="stat-value ${rateClass}">${(yieldRate * 100).toFixed(1)}%</div>
      <div class="stat-sub">æœ‰åŠ¹ã‚¨ãƒªã‚¢åŸºæº– / åŸæ¿å…¨ä½“ ${(plateArea/1e6).toFixed(3)}ã¡</div>
    </div>
    <div class="stat-block">
      <div class="stat-label">ç«¯æãƒ­ã‚¹é¢ç©</div>
      <div class="stat-value ${lossArea / plateArea > 0.4 ? 'danger' : 'warn'}">${(lossArea / 1e6).toFixed(3)}ã¡</div>
      <div class="stat-sub">ç´„ ${(lossArea / 1e6 * 100).toFixed(1)} dmÂ²</div>
    </div>
    <div class="stat-block">
      <div class="stat-label">ç™ºæ³¨ ${qty} æšã«å¿…è¦ãªåŸæ¿</div>
      <div class="stat-value">${platesNeeded} æš</div>
      <div class="stat-sub">${count > 0 ? `ä½™ã‚Š ${count * platesNeeded - qty}æš ï¼ˆäºˆå‚™æ ï¼‰` : '1æšã‚‚å–ã‚Œã¾ã›ã‚“'}</div>
    </div>
    ${count === 0 ? `<div class="stat-block" style="border-color:var(--danger); background: rgba(244,67,54,0.08);">
      <div class="stat-label" style="color:var(--danger);">âš ï¸ æ³¨æ„</div>
      <div class="stat-sub" style="color:var(--warn); line-height:1.6;">éƒ¨æãŒåŸæ¿ã‚ˆã‚Šå¤§ãã„ã‹ã€å–ã‚Œæ•°ãŒ0ã§ã™ã€‚åˆ¥ã®åŸæ¿ã‚µã‚¤ã‚ºã‚’é¸ã¶ã‹ã€éƒ¨æã‚’å›è»¢ã—ã¦ãã ã•ã„ã€‚</div>
    </div>` : ''}
    <div class="stat-block" style="background: rgba(0,230,118,0.05); border-color: rgba(0,230,118,0.25);">
      <div class="stat-label" style="color:var(--muted);">ğŸ”„ 90Â°å›è»¢æ™‚</div>
      <div class="stat-sub" style="color:var(--muted); line-height:1.7;">
        ${(function(){
          const rw = ph, rh = pw;
          const rc = Math.floor(effectiveW / rw);
          const rr = Math.floor(effectiveH / rh);
          const rcount = rc * rr;
          return `å›è»¢å¾Œ: ${rcount}æš (${rc}Ã—${rr})${rcount > count ? ' â† <b style="color:var(--optimal)">ã“ã¡ã‚‰ãŒå¤šã„</b>' : rcount === count ? ' â† åŒã˜' : ''}`;
        })()}
      </div>
    </div>
  `;
}

// ===============================
// è¦‹ç©è¨ˆç®—ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
// ===============================
function calculate() {
  const w   = parseInt(document.getElementById('width').value)  || 0;
  const h   = parseInt(document.getElementById('height').value) || 0;
  const qty = parseInt(document.getElementById('qty').value)    || 1;
  const subKey    = document.getElementById('substrate').value;
  const filmKey   = document.getElementById('film').value;
  const edgeType  = document.getElementById('edge_type').value;
  const useMinArea = document.getElementById('minAreaRule').checked;
  const useTape   = document.getElementById('tapeOption').checked;
  const applyRevision = document.getElementById('hamashinRevision').checked;

  if (w <= 0 || h <= 0) { alert('æ•°å€¤ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  let rawArea = (w * h) / 1000000;
  const perimeter = 2 * (w + h) / 1000;
  const calcArea  = (useMinArea && rawArea < 0.3) ? 0.3 : rawArea;

  const results = ['hamashin', 'bando'].map(m => {
    const config = MASTER[m];
    const subPrice  = config.sub[subKey];
    const filmPrice = config.film[filmKey];

    let costBase     = config.fixed;
    let costMaterial = calcArea * (subPrice + filmPrice);
    let actualEdge   = (edgeType === 'migaki') ? config.edge_price : 0;
    let costEdge     = perimeter * actualEdge;
    let costOption   = useTape ? 150 : 0;
    let subTotal     = costBase + costMaterial + costEdge + costOption;

    let discountAmount = 0, isDiscounted = false;
    if (qty >= config.discountThreshold) {
      discountAmount = subTotal * config.discountRate;
      isDiscounted = true;
    }
    let afterDiscount = subTotal - discountAmount;

    let correction = 1.0;
    if (Math.max(w, h) > 1500) correction = 1.3;
    else if (Math.max(w, h) > 1000) correction = 1.1;
    let correctionAmount = afterDiscount * (correction - 1.0);
    let priceBeforeRevision = afterDiscount + correctionAmount;

    let revisionAmount = 0, isRevised = false;
    if (m === 'hamashin' && applyRevision) {
      revisionAmount = priceBeforeRevision * 0.10;
      isRevised = true;
    }

    let finalPrice = Math.round((priceBeforeRevision + revisionAmount) / 10) * 10;
    return {
      id: m, price: finalPrice, calcArea, perimeter,
      costBase, costMaterial, costEdge, costOption,
      discountAmount, correctionAmount, correction,
      isLarge: Math.max(w, h) > 1500, isDiscounted,
      discountRate: config.discountRate,
      subPriceUnit: subPrice, filmPriceUnit: filmPrice,
      revisionAmount, isRevised
    };
  });

  display(results, w, h, qty, subKey, filmKey, (useMinArea && rawArea < 0.3), applyRevision);

  // æ­©ç•™ã¾ã‚Šæ›´æ–°
  _yieldState.w = w;
  _yieldState.h = h;
  document.getElementById('yield-section').style.display = 'block';
  renderYield();
}

function display(res, w, h, qty, subKey, filmKey, minAreaApplies, applyRevision) {
  const section = document.getElementById('result-section');
  section.style.display = 'block';
  const grid = document.getElementById('result-grid');
  const ham = res[0]; const ban = res[1];
  const ratio = (ham.price / ban.price).toFixed(2);

  let hamashinStatusHtml = '', rowJudgementHtml = '';
  if (ham.price <= ban.price) {
    hamashinStatusHtml = '<div style="background:var(--optimal); color:#000; font-size:10px; font-weight:900; padding:2px 6px; border-radius:4px; display:inline-block; margin-top:12px;">æœ€å®‰ãƒ»æ¨å¥¨</div>';
    rowJudgementHtml   = '<span style="color:var(--optimal);font-weight:700;">æµœæ–°ãŒæœ€å®‰</span>';
  } else if (ratio <= 1.25) {
    hamashinStatusHtml = `<div style="background:var(--acceptable); color:#000; font-size:10px; font-weight:900; padding:2px 6px; border-radius:4px; display:inline-block; margin-top:12px;">ğŸ›¡ï¸ æˆ¦ç•¥çš„è¨±å®¹æ  (${ratio}å€)</div>`;
    rowJudgementHtml   = `<span style="color:var(--acceptable);font-weight:700;">2ç¤¾è³¼è²·æ </span>`;
  } else {
    hamashinStatusHtml = `<div style="background:var(--warn); color:#000; font-size:10px; font-weight:900; padding:2px 6px; border-radius:4px; display:inline-block; margin-top:12px;">âš ï¸ ã‚³ã‚¹ãƒˆè¶…é (${ratio}å€)</div>`;
    rowJudgementHtml   = `<span style="color:var(--warn);font-weight:700;">å‚æ±ã¸é›†ç´„</span>`;
  }

  document.getElementById('logic-info').innerText = applyRevision ? "â€»2026å¹´3æœˆæ”¹å®šä¾¡æ ¼ã‚’é©ç”¨ä¸­" : "";

  grid.innerHTML = res.map(r => {
    let statusBadge = '', cardClass = '';
    if (r.id === 'hamashin') {
      statusBadge = hamashinStatusHtml;
      if (ratio <= 1.25 && ratio > 1.0) cardClass = 'acceptable';
      if (ham.price <= ban.price) cardClass = 'optimal';
    } else {
      if (ban.price < ham.price) {
        statusBadge = '<div style="background:var(--optimal); color:#000; font-size:10px; font-weight:900; padding:2px 6px; border-radius:4px; display:inline-block; margin-top:12px;">æœ€å®‰ãƒ»ãƒ™ãƒ¼ã‚¹æ¨å¥¨</div>';
        cardClass = 'optimal';
      }
    }
    return `
    <div class="company-card ${cardClass}">
      <div class="price-label" style="font-weight:bold; font-size:13px; color: ${r.id==='hamashin' ? 'var(--hamashin)' : 'var(--bando)'};">
        ${r.id === 'hamashin' ? 'æµœæ–°ç¡å­' : 'å‚æ±ã‚¬ãƒ©ã‚¹åº—'}
      </div>
      <div class="price-main">Â¥${r.price.toLocaleString()}</div>
      <div class="price-label">åˆè¨ˆ: Â¥${(r.price * qty).toLocaleString()}</div>
      <div class="breakdown-section">
        <div class="breakdown-title">â”€â”€ ã‚³ã‚¹ãƒˆå†…è¨³ (1æšã‚ãŸã‚Š) â”€â”€</div>
        <div class="breakdown-row"><span>åŸºæœ¬å›ºå®šè²»</span><span>Â¥${Math.round(r.costBase).toLocaleString()}</span></div>
        <div class="breakdown-row"><span>ææ–™è²» <span style="font-size:9px;color:var(--muted)">(${r.calcArea.toFixed(3)}ã¡)</span></span><span>Â¥${Math.round(r.costMaterial).toLocaleString()}</span></div>
        <div class="breakdown-row" style="padding-left:10px; font-size:9px; color:var(--muted);">
          <span>â”” ã‚¬ãƒ©ã‚¹: Â¥${r.subPriceUnit.toLocaleString()}/ã¡ | ãƒ•ã‚£ãƒ«ãƒ : Â¥${r.filmPriceUnit.toLocaleString()}/ã¡</span>
        </div>
        <div class="breakdown-row"><span>ã‚¨ãƒƒã‚¸åŠ å·¥è²» <span style="font-size:9px;color:var(--muted)">(${r.perimeter.toFixed(2)}m)</span></span><span>Â¥${Math.round(r.costEdge).toLocaleString()}</span></div>
        ${r.costOption > 0 ? `<div class="breakdown-row"><span>ç‰¹æ®ŠåŠ å·¥è²»</span><span>Â¥${Math.round(r.costOption).toLocaleString()}</span></div>` : ''}
        ${r.isDiscounted ? `<div class="breakdown-row highlight-opt"><span>é‡ç”£å‰²å¼• (-${r.discountRate*100}%)</span><span>-Â¥${Math.round(r.discountAmount).toLocaleString()}</span></div>` : ''}
        ${r.correction > 1 ? `<div class="breakdown-row highlight-warn"><span>å¤§åˆ¤è£œæ­£ (Ã—${r.correction})</span><span>+Â¥${Math.round(r.correctionAmount).toLocaleString()}</span></div>` : ''}
        ${r.isRevised ? `<div class="breakdown-row highlight-danger"><span>ğŸ“ˆ '26å¹´3æœˆæ”¹å®š (+10%)</span><span>+Â¥${Math.round(r.revisionAmount).toLocaleString()}</span></div>` : ''}
      </div>
      ${statusBadge}
    </div>`;
  }).join('');

  // å¸‚å ´ã‚¤ãƒ³ã‚µã‚¤ãƒˆ
  const marketInsight = document.getElementById('market-insight');
  const marketCost = MARKET_COST[subKey];
  const hamMargin = ham.subPriceUnit - marketCost;
  const banMargin = ban.subPriceUnit - marketCost;
  marketInsight.innerHTML = `
    <div class="market-insight-title">ğŸ” åŸæ¿ä¾¡æ ¼ç›¸å ´ã¨ãƒ¡ãƒ¼ã‚«ãƒ¼åˆ©å¹…ã®æ¨æ¸¬ (1ã¡ã‚ãŸã‚Š / ${LABELS.sub[subKey]})</div>
    <div class="market-grid">
      <div class="market-col" style="border-color: rgba(255,255,255,0.2);">
        <div class="market-col-title">å¸‚å ´ã®åŸæ¿å¸å€¤ (ç›®å®‰)</div>
        <div class="market-price">ç´„ Â¥${marketCost.toLocaleString()}</div>
        <div class="market-margin" style="color:var(--muted);">ç´”ç²‹ãªææ–™åŸä¾¡</div>
      </div>
      <div class="market-col" style="border-color: var(--hamashin);">
        <div class="market-col-title">æµœæ–°ã®è¨­å®šå˜ä¾¡</div>
        <div class="market-price" style="color:var(--hamashin);">Â¥${ham.subPriceUnit.toLocaleString()}</div>
        <div class="market-margin margin-high">æ¨æ¸¬åˆ©å¹…: +Â¥${hamMargin.toLocaleString()}</div>
      </div>
      <div class="market-col" style="border-color: var(--bando);">
        <div class="market-col-title">å‚æ±ã®è¨­å®šå˜ä¾¡</div>
        <div class="market-price" style="color:var(--bando);">Â¥${ban.subPriceUnit.toLocaleString()}</div>
        <div class="market-margin ${banMargin < hamMargin ? 'margin-low' : 'margin-high'}">æ¨æ¸¬åˆ©å¹…: +Â¥${banMargin.toLocaleString()}</div>
      </div>
    </div>
  `;

  // ãƒ­ã‚°
  const logBody = document.getElementById('log-body');
  const diff = Math.abs(ham.price - ban.price);
  logBody.insertAdjacentHTML('afterbegin', `<tr>
    <td>${w} Ã— ${h}</td><td>${qty}</td>
    <td>${LABELS.sub[subKey]}/${LABELS.film[filmKey]}</td>
    <td style="color:var(--hamashin)">Â¥${ham.price.toLocaleString()}</td>
    <td style="color:var(--bando)">Â¥${ban.price.toLocaleString()}</td>
    <td style="font-weight:bold;">${ratio}å€</td>
    <td>${rowJudgementHtml}</td>
    <td>Â¥${diff.toLocaleString()}</td>
  </tr>`);
}

function copyTSV() {
  const rows = Array.from(document.querySelectorAll('#log-body tr'));
  if (rows.length === 0) { alert('ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const text = rows.map(r => Array.from(r.cells).map(c => c.innerText.replace(/Â¥|,/g, '')).join('\t')).join('\n');
  navigator.clipboard.writeText("WÃ—H\tQty\tä»•æ§˜\tæµœæ–°å˜ä¾¡\tå‚æ±å˜ä¾¡\tå€ç‡\tåˆ¤å®š\tå·®é¡\n" + text)
    .then(() => alert("Excelè²¼ã‚Šä»˜ã‘ç”¨ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"));
}

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
window.addEventListener('resize', () => { if (_yieldState.w) renderYield(); });
</script>
</body>
</html>